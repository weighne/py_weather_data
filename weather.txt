#!/bin/bash

#TEMP
rm /var/www/htdocs/nenie.net/report.txt

#Download current METAR, remove the first line, convert spaces to newlines.
#----
wget -q -O /var/tmp/raw.txt https://tgftp.nws.noaa.gov/data/observations/metar/stations/KMGJ.TXT
sed -i '1d' /var/tmp/raw.txt
tr ' ' '\n' < /var/tmp/raw.txt > /var/tmp/metar.txt

#Capture temperature
#----
echo -n 'Temperaturo estas ' >> /var/www/htdocs/nenie.net/report.txt
temp=$(grep -E '[0-9]+\/[0-9]+' /var/tmp/metar.txt | cut -d '/' -f 1)
echo -n $temp >> /var/www/htdocs/nenie.net/report.txt
echo -n ' celsiaj gradoj. ' >> /var/www/htdocs/nenie.net/report.txt

#Sky conditions and precipitation
#----
sky='Klara ĉielo.'
if [[ $(grep -E 'FEW[0-9]+' /var/tmp/metar.txt | cut -c -3) != '' ]]; then
	sky='Plejparte suna.'
fi
if [[ $(grep -E 'SCT[0-9]+' /var/tmp/metar.txt | cut -c -3) != '' ]]; then
	sky='Parte nuba.'
fi
if [[ $(grep -E 'BKN[0-9]+' /var/tmp/metar.txt | cut -c -3) != '' ]]; then
	sky='Plejparte nuba.'
fi
if [[ $(grep -E 'OVC[0-9]+' /var/tmp/metar.txt | cut -c -3) != '' ]]; then
	sky='Tute nuba.'
fi
if [[ $(grep -E 'RA' /var/tmp/metar.txt | cut -c -3) != '' ]]; then
	sky='Pluvas.'
fi
if [[ $(grep -E 'DZ' /var/tmp/metar.txt | cut -c -3) != '' ]]; then
	sky='Pluvetas.'
fi
if [[ $(grep -E 'SN' /var/tmp/metar.txt | cut -c -3) != '' ]]; then
	sky='Neĝas.'
fi
echo -n $sky >> /var/www/htdocs/nenie.net/report.txt

#Wind direction
#----
echo -n ' La vento ' >> /var/www/htdocs/nenie.net/report.txt
winddir=$(grep -E '[0-9].+KT' /var/tmp/metar.txt | cut -c -3)
gustspd=''
case $winddir in
	350 | 360 | 010)
		dir='blovas el la nordo ';;
	020 | 030)
		dir='blovas el la nord-nordoriento ';;
	040 | 050)
		dir='blovas el la nordoriento ';;
	060 | 070)
		dir='blovas el la orient-nordoriento ';;
	080 | 090 | 100)
		dir='blovas el la oriento ';;
	110 | 120)
		dir='blovas el la oriento-sudoriento ';;
	130 | 140)
		dir='blovas el la sudoriento ';;
	150 | 160)
		dir='blovas el la sud-sudoriento ';;
	170 | 180 | 190)
		dir='blovas el la sudo ';;
	200 | 210)
		dir='blovas el la sud-sudokcidento ';;
	220 | 230)
		dir='blovas el la sudokcidento ';;
	240 | 250)
		dir='blovas el la okcident-sudokcidento ';;
	260 | 270 | 280)
		dir='blovas el la okcidento ';;
	290 | 300)
		dir='blovas el la okcident-nordokcidento ';;
	310 | 320)
		dir='blovas el la nordokcidento ';;
	330 | 340)
		dir='blovas el la nord-nordokcidento ';;
	*)
		dir='estas senmova. '
		still=1
esac
echo -n $dir >> /var/www/htdocs/nenie.net/report.txt

#Wind speed
#----
if [[ still -ne 1 ]]; then
	if [[ $(grep -E '[0-9].+KT' /var/tmp/metar.txt | grep 'G') == '' ]]; then
		gustspd=''
		windspd=$(grep -E '[0-9].+KT' /var/tmp/metar.txt | cut -d 'K' -f 1 | cut -c 4-)
	else
		gustspd=$(grep -E '[0-9].+KT' /var/tmp/metar.txt | cut -d 'G' -f 2 | cut -c -2)
		windspd=$(grep -E '[0-9].+KT' /var/tmp/metar.txt | cut -d 'G' -f 1 | cut -c 4-)
	fi
fi

if [[ gustspd -eq '' ]] && [[ still -ne 1 ]]; then
	echo -n ' je '$windspd' nodoj. ' >> /var/www/htdocs/nenie.net/report.txt
elif [[ gustspd -ne '' ]] && [[ still -ne 1 ]]; then
	echo -n ' je '$windspd' nodoj kaj blovegas je '$gustspd' nodoj.' >> /var/www/htdocs/nenie.net/report.txt
fi

#Air pressure
#----
baro=$(grep -E 'A[0-9]+' /var/tmp/metar.txt | cut -d 'A' -f 2)
mbbaro=$(awk -v a=$baro -v b=338639 -v c=1000000 'BEGIN{printf("%.1f\n", a*b/c)}')
echo ' Atmosfera premo estas '$mbbaro' milibaroj.' >> /var/www/htdocs/nenie.net/report.txt

#Cleanup
#----
rm /var/tmp/raw.txt
rm /var/tmp/metar.txt
